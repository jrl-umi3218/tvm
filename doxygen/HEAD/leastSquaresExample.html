<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TVM: A least-squares problem example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="tvmdoxystyle.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TVM
   &#160;<span id="projectnumber">0.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('leastSquaresExample.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">A least-squares problem example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md16"></a>
Preliminaries</h1>
<p>This example assumes that the concepts presented in <a class="el" href="problemWritingExample.html">How to write a problem</a> are somewhat known, in that we will not describe all the details like the creation of space and variables. It aims at showing a simpler case where one want to directly write a constrained linear least-squares problem, without relying on task dynamics and automatic linearization. It showcases the use of <a class="el" href="classtvm_1_1utils_1_1AffineExpr.html">tvm::utils::AffineExpr</a>, which offers a symbolic-like way of writing linear expressions.</p>
<div class="image">
<object type="image/svg+xml" data="staticForceEquilibrium.svg" style="pointer-events: none;"></object>
</div>
<p>In this example we consider a simplified 3-limbs robot whose mass \( m \) is concentrated at its Center of Mass (CoM). The kinematics of the limbs is abstracted, and the robot is in ponctual contact with its environment at each end of its limbs (see figure). At each contact point \( p_i \), the contact force is \( f_i \) and the contact normal is \( n_i \).</p>
<p>We would like to find the position \( c \) of the CoM and a set of forces such that the robot is in static equilibrium. The forces should be as close as possible to desired forces \( f_i^{des} \), and because this does not completely specify the position of the CoM, we will also require the CoM to be close to the contacts.</p>
<p>This can be written as a linear least-squares problem:</p>
<p>\( \begin{align} \min_{f_i, c}. &amp;\ \frac{1}{2} \sum_i \left\| f_i - f_i^{des} \right\|^2 + \frac{w}{2} \sum_i \left\| c - p_i \right\|^2\\ \mbox{s.t.} &amp;\ \sum_i R_i f_i + m g = 0 \\ &amp;\ \sum_i \widehat{p_i} R_i f_i + m \widehat{g} c = 0\\ &amp;\ C f_i \geq 0,\ i=1..3 \\ \end{align} \)</p>
<p>where \( w \) is a weight and \( R_i \) is a rotation matrix such that \( R_i z = n_i\) (with \( z \) the vertical unit vector), i.e. a rotation matrix between the world frame and a contact frame. \( \widehat{x} \) is the skew-symmetric matrix such that for any \( u \), \( \widehat{x} u = x \times u \) (cross product). \( C \) is a matrix expressing the linearized Coulomb friction cone (see e.g. <a href="https://scaron.info/teaching/friction-cones.html">here</a>). The two equality constraints are the Newton-Euler equations where the moments are taken at the origin of the world frames. The forces \( f_i \) are expressed in the local contact frame and brought back in the world frame through the \( R_i \).</p>
<p>Note that</p>
<p>\( \frac{1}{2} \sum_i \left\| f_i - f_i^{des} \right\|^2 + \frac{w}{2} \sum_i \left\| c - p_i \right\|^2 = \frac{1}{2}\left\| \begin{bmatrix} f_1 - f_1^{des} \\ f_2 - f_2^{des} \\ \vdots \\ c - p_1 \\ c - p_2 \\ \vdots \end{bmatrix} \right\|^2_W \) where \( W \) is a diagonal matrix with <code>1</code> and <code>w</code> on the diagonal.</p>
<h1><a class="anchor" id="autotoc_md17"></a>
Implementation outline</h1>
<p>Our main function will be <code>leastSquares3points</code>, and consist of 3 main steps</p><ol type="1">
<li>Declaration of the problem data and variables</li>
<li>Writing of the problem</li>
<li>Solving of the problem</li>
</ol>
<p>We will use three helper functions</p><ul>
<li><code>Matrix3d rotationFromZ(Vector3d v)</code>, which creates a rotation matrix <code>R</code> such that <code> R*Vector3d::UnitZ() == v </code></li>
<li><code>Matrix3d hat(const Vector3d&amp; v)</code>, which returns the skew- symmetric matrix \( \widehat{v} \) as described above</li>
<li><code>MatrixXd discretizedFrictionCone(double mu)</code>, which creates the matrix \( C \) for a four-sided linearized cone with friction coefficient <code>mu</code>.</li>
</ul>
<p>We won't details these methods further.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Implementation details</h1>
<p>Given a 3-dimensionnal space <code>Space S(3)</code>, we create the following data for the first contact point:  </p><div class="fragment"><div class="line">  <span class="comment">// Data for first contact point</span></div>
<div class="line">  Vector3d p1(-1, -1, 0);                  <span class="comment">// Contact point position</span></div>
<div class="line">  Vector3d n1(1, 1, 1);                    <span class="comment">// Normal vector to contact surface</span></div>
<div class="line">  MatrixXd R1 = rotationFromZ(n1);         <span class="comment">// Rotation between world frame and a local contact frame</span></div>
<div class="line">  Vector3d f1des = Vector3d::Zero();       <span class="comment">// Desired force for f1</span></div>
<div class="line">  <a class="code" href="namespacetvm.html#a024f10de786d6592dbd271d3df847835">VariablePtr</a> f1 = S.createVariable(<span class="stringliteral">&quot;f1&quot;</span>); <span class="comment">// Variable creation</span></div>
<div class="ttc" id="anamespacetvm_html_a024f10de786d6592dbd271d3df847835"><div class="ttname"><a href="namespacetvm.html#a024f10de786d6592dbd271d3df847835">tvm::VariablePtr</a></div><div class="ttdeci">std::shared_ptr&lt; Variable &gt; VariablePtr</div><div class="ttdef"><b>Definition:</b> defs.h:65</div></div>
</div><!-- fragment --><p>Here we chose to set the desired force to 0, which will have the effect of trying to minimize the force.</p>
<p>The same is done for the second and third contact points.</p>
<p>Next, we create the data about the weight and CoM: </p><div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> m = 1;                    <span class="comment">// Mass</span></div>
<div class="line">  <span class="keyword">const</span> Vector3d g(0, 0, -9.81);         <span class="comment">// Gravity vector</span></div>
<div class="line">  <a class="code" href="namespacetvm.html#a024f10de786d6592dbd271d3df847835">VariablePtr</a> c = S.createVariable(<span class="stringliteral">&quot;c&quot;</span>); <span class="comment">// Center of mass variable</span></div>
</div><!-- fragment --><p>and define a matrix for the friction cone (we use the same 0.6 friction coefficient for all contacts): </p><div class="fragment"><div class="line">  MatrixXd C = discretizedFrictionCone(0.6); <span class="comment">// Matrix of a discretized cone with friction coefficient 0.6</span></div>
</div><!-- fragment --><p> <a class="el" href="classtvm_1_1LinearizedControlProblem.html">tvm::LinearizedControlProblem</a> can be used to write linear least-squares problem, with a method <code>add</code> that forgoes the need for task dynamics. After creating an instance <code>pb</code>, we can populate it.</p>
<p>First we add the Newton-Euler equations as constraints (priority level 0): </p><div class="fragment"><div class="line">  pb.add(R1 * f1 + R2 * f2 + R3 * f3 + m * g == 0., <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(0)); <span class="comment">// Newton equation</span></div>
<div class="ttc" id="anamespacetvm_1_1requirements_html_aa5d3c61ef15897a9eee0c742a80fbee3"><div class="ttname"><a href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">tvm::requirements::PriorityLevel</a></div><div class="ttdeci">PriorityLevelBase&lt; true &gt; PriorityLevel</div><div class="ttdef"><b>Definition:</b> PriorityLevel.h:33</div></div>
<div class="line">  pb.add(hat(p1) * R1 * f1 + hat(p2) * R2 * f2 + hat(p3) * R3 * f3 + m * hat(g) * c == 0.,</div>
<div class="line">         <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(0));               <span class="comment">// Euler equation</span></div>
</div><!-- fragment --><p>Since these are linear expression, we can write them directly. TVM is providing, with the implicit use of the <a class="el" href="classtvm_1_1utils_1_1AffineExpr.html">tvm::utils::AffineExpr</a> class and operator overload, a way to write such expressions in a symbolic-like way.</p>
<p>Then the friction constraints can be added in the same way </p><div class="fragment"><div class="line">  pb.add(C * f1 &gt;= 0., <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(0)); <span class="comment">// Friction cone constraints</span></div>
<div class="line">  pb.add(C * f2 &gt;= 0., <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(0));</div>
<div class="line">  pb.add(C * f3 &gt;= 0., <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(0));</div>
</div><!-- fragment --><p> Finally the objectives are added (priority level 1): </p><div class="fragment"><div class="line">  pb.add(f1 == f1des, <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1)); <span class="comment">// Desired forces</span></div>
<div class="line">  pb.add(f2 == f2des, <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1));</div>
<div class="line">  pb.add(f3 == f3des, <a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1));</div>
<div class="line">  pb.add(c == p1, {<a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1), <a class="code" href="namespacetvm_1_1requirements.html#ad596b52ac03ded388e26964e3e995866">Weight</a>(1e-4)}); <span class="comment">// Desired CoM position</span></div>
<div class="line">  pb.add(c == p2, {<a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1), <a class="code" href="namespacetvm_1_1requirements.html#ad596b52ac03ded388e26964e3e995866">Weight</a>(1e-4)});</div>
<div class="line">  pb.add(c == p3, {<a class="code" href="namespacetvm_1_1requirements.html#aa5d3c61ef15897a9eee0c742a80fbee3">PriorityLevel</a>(1), <a class="code" href="namespacetvm_1_1requirements.html#ad596b52ac03ded388e26964e3e995866">Weight</a>(1e-4)});</div>
<div class="ttc" id="anamespacetvm_1_1requirements_html_ad596b52ac03ded388e26964e3e995866"><div class="ttname"><a href="namespacetvm_1_1requirements.html#ad596b52ac03ded388e26964e3e995866">tvm::requirements::Weight</a></div><div class="ttdeci">WeightBase&lt; true &gt; Weight</div><div class="ttdef"><b>Definition:</b> Weight.h:38</div></div>
</div><!-- fragment --><p>We use the weight \( w = 10^{-4} \).</p>
<p>Note that, by default, constraints at any level are to be solved in the least- square sense, so that \( f_i = f_i^{des} \) becomes \( \left\| f_i - f_i^{des} \right\| \).</p>
<p>The last thing to do is to chose a resolution scheme and solve the problem: </p><div class="fragment"><div class="line">  <span class="comment">// Creating the resolution scheme</span></div>
<div class="line">  scheme::WeightedLeastSquares solver(solver::DefaultLSSolverOptions().verbose(<span class="keyword">true</span>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// And solving the problem</span></div>
<div class="line">  <span class="keywordtype">bool</span> found = solver.solve(pb);</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md19"></a>
Example file</h2>
<p><a href="https://github.com/jrl-umi3218/tvm/blob/master/examples/LeastSquaresExample.cpp">example/LeastSquaresExample.cpp</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">The TVM library</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
